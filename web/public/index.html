<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>S&P 500 å‘½ä¸­ç‡æ¸¬è©¦å™¨ï¼ˆFMP /stableï¼‰</title>
    <style>
      :root{
        color-scheme: dark;
        --bg:#0b111f;
        --bg-alt:#111a2d;
        --panel:#141e34;
        --panel-strong:#172442;
        --border:rgba(255,255,255,.12);
        --accent:#49c6ff;
        --accent-strong:#7f5bff;
        --text:#f3f6ff;
        --muted:#a6b3d6;
        --success:#00d38f;
        --danger:#ff6b6b;
      }
      *,*::before,*::after{box-sizing:border-box;}
      body{
        margin:0;
        font-family: "Inter","Noto Sans TC", "SF Pro Display",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        background:var(--bg);
        color:var(--text);
        min-height:100vh;
        line-height:1.6;
      }
      body::before{
        content:"";
        position:fixed;
        inset:0;
        background:
          radial-gradient(circle at 30% -20%,rgba(90,125,255,.45),transparent 45%),
          radial-gradient(circle at 80% 0,rgba(0,215,168,.3),transparent 45%),
          radial-gradient(circle at 20% 120%,rgba(91,64,255,.35),transparent 40%);
        z-index:-2;
      }
      body::after{
        content:"";
        position:fixed;
        inset:0;
        background:url("data:image/svg+xml,%3Csvg width='160' height='160' viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 159.5L160 0.5' stroke='rgba(255,255,255,0.02)'/%3E%3C/svg%3E");
        opacity:.35;
        z-index:-1;
      }
      .app-shell{
        max-width:1200px;
        margin:0 auto;
        padding:32px clamp(16px,4vw,48px) 64px;
      }
      .card{
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:28px;
        padding:28px;
        backdrop-filter:blur(18px);
        box-shadow:0 25px 60px rgba(5,8,20,.55);
      }
      .hero{
        margin-bottom:28px;
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap:24px;
      }
      .hero h1{
        margin:8px 0 12px;
        font-size:2.3rem;
        letter-spacing:.02em;
      }
      .eyebrow{
        text-transform:uppercase;
        letter-spacing:.3em;
        font-size:.8rem;
        color:var(--accent);
      }
      .stats-row{
        display:flex;
        gap:16px;
        flex-wrap:wrap;
      }
      .stat-pill{
        min-width:180px;
        padding:16px 20px;
        border-radius:18px;
        background:var(--panel-strong);
        border:1px solid rgba(255,255,255,.1);
        box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
      }
      .stat-label{
        font-size:.85rem;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.25em;
      }
      .stat-value{
        font-size:1.4rem;
        font-weight:600;
      }
      .main-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
        gap:24px;
        margin-bottom:24px;
      }
      .panel-title{
        font-size:1.2rem;
        margin:0 0 10px;
        font-weight:600;
        color:#fff;
      }
      .panel-sub{
        margin:0 0 22px;
        color:var(--muted);
        font-size:1rem;
      }
      .form-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
        gap:16px;
      }
      label{
        font-size:.95rem;
        color:#d8e3ff;
        display:block;
        margin-bottom:6px;
      }
      input,select,textarea{
        width:100%;
        border-radius:18px;
        border:1px solid rgba(255,255,255,.2);
        background:rgba(7,13,30,.9);
        color:var(--text);
        padding:.75rem .95rem;
        font-size:1.05rem;
        transition:border .2s, box-shadow .2s, transform .15s;
      }
      input:focus,select:focus,textarea:focus{
        outline:none;
        border-color:var(--accent);
        box-shadow:0 0 0 3px rgba(73,198,255,.25);
        transform:translateY(-1px);
      }
      textarea{min-height:140px; resize:vertical;}
      .range-inline{
        display:flex;
        gap:8px;
        align-items:center;
      }
      .range-inline input{flex:1;}
      .action-bar{
        display:flex;
        flex-wrap:wrap;
        gap:16px;
        align-items:center;
        margin-bottom:24px;
      }
      button{
        border:none;
        border-radius:999px;
        padding:1rem 2.2rem;
        font-size:1.05rem;
        font-weight:600;
        cursor:pointer;
        transition:transform .15s, box-shadow .15s, opacity .15s;
      }
      #runBtn{
        background:linear-gradient(120deg,var(--accent),var(--accent-strong));
        color:#111;
        box-shadow:0 10px 25px rgba(70,200,255,.35);
      }
      #runBtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
      #runBtn:not(:disabled):hover{transform:translateY(-1px);}
      #stopBtn{
        background:transparent;
        color:var(--muted);
        border:1px solid rgba(255,255,255,.25);
      }
      #stopBtn:disabled{opacity:.35;cursor:not-allowed;}
      .muted{color:var(--muted);}
      .status-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
        gap:16px;
        margin-bottom:24px;
      }
      .status-card{
        padding:22px 24px;
        border-radius:22px;
        background:var(--panel-strong);
        border:1px solid rgba(255,255,255,.08);
        box-shadow:0 12px 30px rgba(0,0,0,.4);
      }
      .status-card h4{
        margin:0 0 8px;
        font-size:.95rem;
        letter-spacing:.2em;
        text-transform:uppercase;
        color:var(--muted);
      }
      table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        margin-top:16px;
        overflow:hidden;
        border-radius:18px;
        box-shadow:0 20px 35px rgba(0,0,0,.35);
      }
      th,td{
        padding:14px 18px;
        text-align:left;
        font-size:1rem;
      }
      thead{
        background:rgba(255,255,255,.06);
      }
      tbody tr:nth-child(odd){
        background:rgba(255,255,255,.02);
      }
      tbody tr:hover{
        background:rgba(73,198,255,.12);
      }
      .badge{
        display:inline-flex;
        align-items:center;
        gap:6px;
        font-size:.85rem;
        padding:.25rem .75rem;
        border-radius:999px;
        font-weight:600;
      }
      .good{background:rgba(0,211,143,.12);color:var(--success);}
      .bad{background:rgba(255,107,107,.12);color:var(--danger);}
      #overall{
        margin-top:12px;
      }
      #overall h3{
        margin-bottom:12px;
        font-size:1.45rem;
      }
      #overall a{
        color:var(--accent);
        text-decoration:none;
        font-weight:700;
      }
      @media(max-width:640px){
        .hero{padding:16px;}
        .card{padding:20px;}
        .range-inline{flex-direction:column;align-items:stretch;}
        button{width:100%;text-align:center;}
        .stat-pill{min-width:100%; justify-content:space-between;}
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="hero card">
        <div>
          <div class="eyebrow">S&P 500 Backtester</div>
          <h1>S&P 500 å‘½ä¸­ç‡æ¸¬è©¦å™¨</h1>
          <p class="muted">ä»¥ FMP stable API + Analyzer API é©…å‹•ï¼Œæ‰¹æ¬¡é©—è­‰ BUY/SELL å‘½ä¸­ç‡ï¼Œæ­é… Zeabur ä¸€éµéƒ¨ç½²ã€‚</p>
        </div>
        <div class="stats-row">
          <div class="stat-pill">
            <div class="stat-label">Analyzer</div>
            <div class="stat-value">/api/analyze</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">LLM Stack</div>
            <div class="stat-value">GPT-5 + 4o-mini</div>
          </div>
        </div>
      </header>

      <div class="main-grid">
        <section class="card">
          <h3 class="panel-title">å›æ¸¬æœŸé–“</h3>
          <p class="panel-sub">è¨­å®šèµ·è¨–æ—¥æœŸèˆ‡åˆ†æé »ç‡ï¼Œç³»çµ±æœƒæŒ‰æœŸå‘ Analyzer è«‹æ±‚è©•ç´šã€‚</p>
          <div class="form-grid">
            <div>
              <label>é–‹å§‹æ—¥æœŸ</label>
              <input type="date" id="startDate" value="2024-01-01">
            </div>
            <div>
              <label>çµæŸæ—¥æœŸ</label>
              <input type="date" id="endDate" value="2025-01-01">
            </div>
            <div>
              <label>é–“éš”</label>
              <select id="interval">
                <option value="week">é€±</option>
                <option value="month" selected>æœˆ</option>
                <option value="quarter">å­£</option>
              </select>
            </div>
          </div>
        </section>

        <section class="card">
          <h3 class="panel-title">é¸è‚¡æ¢ä»¶</h3>
          <p class="panel-sub">å¯é¸æ“‡æ¼²å¹…ã€æœ€æ–°å¸‚å€¼ã€æŒ‡å®šæ—¥æœŸå¸‚å€¼æˆ–æ‰‹å‹•æ¸…å–®ã€‚</p>
          <div class="form-grid">
            <div>
              <label>é¡å‹</label>
              <select id="selType">
                <option value="return">å€é–“æ¼²å¹… Top N</option>
                <option value="mcap_latest">å¸‚å€¼ Top Nï¼ˆæœ€æ–°ï¼‰</option>
                <option value="mcap_asof">å¸‚å€¼ Top Nï¼ˆæŒ‡å®šæ—¥æœŸï¼‰</option>
                <option value="manual">æ‰‹å‹•æ¸…å–®ï¼ˆé€—è™Ÿ/ç©ºç™½åˆ†éš”ï¼‰</option>
              </select>
            </div>
            <div>
              <label>Top N</label>
              <input type="number" id="topN" min="1" max="500" value="50">
            </div>
            <div id="rangeBox">
              <label>æ¼²å¹…å€é–“</label>
              <div class="range-inline">
                <input type="date" id="retFrom" value="2024-01-01">
                <span class="muted">â†’</span>
                <input type="date" id="retTo" value="2024-12-31">
              </div>
            </div>
            <div id="asofBox" style="display:none">
              <label>å¸‚å€¼æ—¥æœŸ</label>
              <input type="date" id="asOf" value="2025-12-31">
            </div>
          </div>
          <div style="margin-top:18px">
            <label>Sector ç¯©é¸ï¼ˆå¯å¤šé¸ï¼‰</label>
            <select id="sectors" multiple size="5" style="width:100%;"></select>
          </div>
          <div id="manualBox" style="display:none;margin-top:18px">
            <label>æ‰‹å‹•è‚¡ç¥¨</label>
            <textarea id="manualTickers" placeholder="ä¾‹å¦‚ï¼šAAPL, MSFT, NVDA"></textarea>
          </div>
        </section>
      </div>

      <div class="card">
        <div class="action-bar">
          <button id="runBtn">âš¡ é–‹å§‹æ¸¬è©¦</button>
          <button id="stopBtn" disabled>åœæ­¢</button>
          <span class="muted">æ”¯æ´æ‰¹æ¬¡ Analyzer å‘¼å«ã€è‡ªå‹•çµ±è¨ˆå‘½ä¸­ç‡ä¸¦è¼¸å‡º Excelã€‚</span>
        </div>
        <div class="status-grid">
          <div class="status-card">
            <h4>åŸ·è¡Œç‹€æ…‹</h4>
            <p id="log" class="muted">å°šæœªåŸ·è¡Œ</p>
          </div>
          <div class="status-card">
            <h4>è³‡æºä½¿ç”¨</h4>
            <p id="usageStats" class="muted">â€”</p>
          </div>
        </div>
        <div id="overall"></div>
        <div id="table"></div>
      </div>
    </div>

    <script>
      const $ = (s)=>document.querySelector(s);
      const sectorsEl = $("#sectors");
      const selTypeEl = $("#selType");
      const manualBox = $("#manualBox");
      const rangeBox = $("#rangeBox");
      const asofBox = $("#asofBox");
      const runBtn = $("#runBtn");
      const stopBtn = $("#stopBtn");
      const logEl = $("#log");
      const overallEl = $("#overall");
      const tableEl = $("#table");
      const usageEl = $("#usageStats");
      const nf = new Intl.NumberFormat("en-US");
      const costFmt = new Intl.NumberFormat("en-US", { minimumFractionDigits: 4, maximumFractionDigits: 4 });
      let isRunning = false;
      let stopInFlight = false;

      selTypeEl.addEventListener("change", ()=>{
        const t = selTypeEl.value;
        manualBox.style.display = (t==="manual")?"block":"none";
        rangeBox.style.display = (t==="return")?"block":"none";
        asofBox.style.display = (t==="mcap_asof")?"block":"none";
      });

      function setRunning(running){
        isRunning = running;
        runBtn.disabled = running;
        stopBtn.disabled = !running;
        if(!running) stopInFlight = false;
      }

      function renderUsage(usage){
        if(!usage){ usageEl.textContent = ""; return; }
        const prompt = Number(usage.prompt || 0);
        const completion = Number(usage.completion || 0);
        const total = Number.isFinite(usage.total) ? usage.total : (prompt + completion);
        const cost = Number.isFinite(usage.cost) ? usage.cost : null;
        const duration = Number.isFinite(usage.durationMs) ? usage.durationMs / 1000 : null;
        const parts = [
          `Token ä½¿ç”¨ï¼šPrompt ${nf.format(prompt)} + Completion ${nf.format(completion)} = ${nf.format(total)} tokens`
        ];
        if(cost != null) parts.push(`æˆæœ¬ $${costFmt.format(cost)}`);
        parts.push(`Analyzer å‘¼å« ${nf.format(usage.calls || 0)} æ¬¡`);
        if(duration != null) parts.push(`è€—æ™‚ ${duration.toFixed(1)} ç§’`);
        usageEl.textContent = parts.join(" ï½œ ");
      }

      function renderResults(j){
        const o = j.overall || {};
        const hr = o.hitRate!=null ? (o.hitRate*100).toFixed(2)+"%" : "â€”";
        overallEl.innerHTML = `
          <h3>ç¸½å‘½ä¸­ç‡ <span class="badge ${o.hitRate>=.5?"good":"bad"}">${hr}</span></h3>
          <div class="muted">Actionable=${o.actionable} | Buyå‘½ä¸­ç‡=${o.buyHitRate!=null?(o.buyHitRate*100).toFixed(1)+"%":"â€”"} | Sellå‘½ä¸­ç‡=${o.sellHitRate!=null?(o.sellHitRate*100).toFixed(1)+"%":"â€”"}</div>
          <p><a href="${j.downloadUrl}">â¬‡ï¸ ä¸‹è¼‰ Excel</a></p>
        `;
        const rows = j.summary || [];
        const trs = rows.map(r=>`
          <tr>
            <td>${r.ticker}</td>
            <td>${r.actionable}</td>
            <td>${r.hits}</td>
            <td>${r.hitRate!=null?(r.hitRate*100).toFixed(1)+"%":"â€”"}</td>
            <td>${r.buy}</td>
            <td>${r.buyHits}</td>
            <td>${r.buyHitRate!=null?(r.buyHitRate*100).toFixed(1)+"%":"â€”"}</td>
            <td>${r.sell}</td>
            <td>${r.sellHits}</td>
            <td>${r.sellHitRate!=null?(r.sellHitRate*100).toFixed(1)+"%":"â€”"}</td>
          </tr>`).join("");
        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Ticker</th><th>Actionable</th><th>Hits</th><th>Hit Rate</th>
                <th>Buy</th><th>Buy Hits</th><th>Buy Hit Rate</th>
                <th>Sell</th><th>Sell Hits</th><th>Sell Hit Rate</th>
              </tr>
            </thead><tbody>${trs}</tbody>
          </table>`;
      }

      async function loadMeta(){
        const r = await fetch("/api/meta"); const j = await r.json();
        (j.sectors||[]).forEach(s=>{
          const opt = document.createElement("option");
          opt.value = s; opt.textContent = s;
          sectorsEl.appendChild(opt);
        });
      }
      loadMeta();

      runBtn.addEventListener("click", async ()=>{
        if(isRunning) return;
        setRunning(true);
        logEl.textContent = "â³ æ¸¬è©¦ä¸­â€¦";
        usageEl.textContent = "";
        overallEl.innerHTML = ""; tableEl.innerHTML = "";
        const body = {
          startDate: $("#startDate").value,
          endDate: $("#endDate").value,
          interval: $("#interval").value,
          selector: {
            type: $("#selType").value,
            topN: Number($("#topN").value),
            from: $("#retFrom").value,
            to: $("#retTo").value,
            asOf: $("#asOf").value,
            sectors: Array.from(sectorsEl.selectedOptions).map(o=>o.value),
            tickers: $("#manualTickers").value
          }
        };
        try{
          const res = await fetch("/api/run-test",{
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(body)
          });
          let j = {};
          try{ j = await res.json(); }catch{}
          if (!res.ok){
            logEl.textContent = j.cancelled ? "ğŸ›‘ å·²å¼·åˆ¶åœæ­¢" : ("âŒ " + (j?.error||"Unknown error"));
            renderUsage(j?.tokenUsage);
            return;
          }
          logEl.textContent = "âœ… å®Œæˆ";
          renderUsage(j.tokenUsage);
          renderResults(j);
        }catch(err){
          logEl.textContent = "âŒ " + err.message;
        }finally{
          setRunning(false);
        }
      });

      stopBtn.addEventListener("click", async ()=>{
        if(!isRunning || stopInFlight) return;
        stopInFlight = true;
        logEl.textContent = "ğŸ›‘ é€å‡ºåœæ­¢è«‹æ±‚â€¦";
        try{
          const res = await fetch("/api/run-test/stop", { method:"POST" });
          const j = await res.json().catch(()=>({}));
          if(j.cancelled){
            logEl.textContent = "ğŸ›‘ æ­£åœ¨åœæ­¢â€¦";
          }else{
            logEl.textContent = "â„¹ï¸ ç•¶å‰æ²’æœ‰åŸ·è¡Œä¸­çš„ä»»å‹™";
            stopInFlight = false;
          }
        }catch(err){
          logEl.textContent = "âš ï¸ åœæ­¢å¤±æ•—ï¼š" + err.message;
          stopInFlight = false;
        }
      });
    </script>
  </body>
</html>
